---
title: "Assignment 1"
author: "Shayla Nikzad"
date: "9/29/2020"
output: html_document
---
## Setup
```{r setup, include = F}
knitr::opts_chunk$set(warning = F, message = F)
```

## Loading Libraries
```{r}
library(tidyverse)
library(plotly)
library(sf)
library(tigris)
library(leaflet)
library(censusapi)

Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```

## Loading the Data
```{r}

years <- 2017:2020
quarters <- 1:4 
types <- list("Electric", "Gas")

pge_elec <- NULL
pge_gas <- NULL

for(year in years) {
 
   for (quarter in quarters) {
     
     if(year == 2020){
      
        if(quarter == 4){
        
           next
       }
     }
     
     for (type in types) {
 
        filename <- paste0("PGE_", year, "_Q", quarter, "_", type, "UsageByZip.csv")
        temp <- read_csv(filename) 
      
      
        if(type == "Electric") {

          pge_elec <- rbind(pge_elec, temp)
        
       }
      
        if(type == "Gas") {
  
          pge_gas <- rbind(pge_gas, temp)
          
        }
      }
    }
  }

```



## Processing Data 
```{r}

#load the bay area zip codes

zipcodes <- read_csv("bayarea_zipcodes.csv")
zips <- zipcodes[,3]

bay_zips <- NULL

indexes <- 1:187
for (index in indexes){
  temp <- toString(zips[index,1])
  bay_zips <- c(bay_zips, temp)
}


#Filtering and processing electric and gas data 
years <- 2017:2020
quarters <- 1:4 
types <- list("Electric", "Gas")

pge <- NULL


for(year in years) {
 
   for (quarter in quarters) {
     
     if(year == 2020){
      
        if(quarter == 4){
        
           next
       }
     }
     
     for (type in types) {
 
        filename <- paste0("PGE_", year, "_Q", quarter, "_", type, "UsageByZip.csv")
        temp <- read_csv(filename) 
      
      
        if(type == "Electric") {
          
            temp_final <-
              temp %>%
                filter( CUSTOMERCLASS %in% 
                    c(
                      "Elec- Residential",
                      "Elec- Commercial"), 
                    ZIPCODE %in%
                      bay_zips) %>% 
              mutate(
                TOTALKBTUs =
                  TOTALKWH*3.412
              )%>%
              select(
                !c(COMBINED, AVERAGEKWH, TOTALKWH, TOTALCUSTOMERS)
                )
        }
        
          if(type == "Gas") {
          
            temp_final <-
              temp %>%
                filter( CUSTOMERCLASS %in% 
                    c(
                      "Gas- Residential",
                      "Gas- Commercial"), 
                    ZIPCODE %in%
                      bay_zips) %>% 
                mutate(
                TOTALKBTUs =
                  TOTALTHM*29.3
              )%>%
              select(
                !c(COMBINED, AVERAGETHM, TOTALTHM, TOTALCUSTOMERS)
                )
          }
        
        pge <-  rbind(pge, temp_final)
     }
   }
}
  


#sum over zipcodes 
pge_final <-
  pge %>%
  group_by(YEAR, MONTH, CUSTOMERCLASS) %>% 
  summarize(
    SUMKBTUs = 
      sum(
        TOTALKBTUs, 
        na.rm = T
      )
  )


#isolate commercial and residential 

pge_comm_gas <- filter(pge_final, CUSTOMERCLASS %in% c("Gas- Commercial"))
pge_comm_elec <- filter(pge_final, CUSTOMERCLASS %in% c("Elec- Commercial"))

pge_res_gas <- filter(pge_final, CUSTOMERCLASS %in% c("Gas- Residential"))
pge_res_elec <- filter(pge_final, CUSTOMERCLASS %in% c("Elec- Residential"))

```


## Generate Plots 

```{r}
#create data sets for graphing 

DATE <- seq(as.Date("2017-01-01"), by="1 month", length.out=45)
CLASS <- c(rep(c("GAS"), 45), rep(c("ELECTRIC"), 45))
BTUs_comm <- c(pge_comm_gas$SUMKBTUs, pge_comm_elec$SUMKBTUs)
BTUs_res <- c(pge_res_gas$SUMKBTUs, pge_res_elec$SUMKBTUs)
DATA_comm = data.frame(DATE, CLASS, BTUs_comm)
DATA_res = data.frame(DATE, CLASS, BTUs_res)

#commercial graph 

pge_commercial <-
  DATA_comm %>% 
  ggplot() +
  geom_bar(
    aes(
      x = DATE,
      y = BTUs_comm,
      fill = CLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    y = "kBTUs",
    title = "Bay Area Commercial Energy Usage"
  )


pge_commercial %>% ggplotly()

#residential graph 

pge_residential <-
  DATA_res %>% 
  ggplot() +
  geom_bar(
    aes(
      x = DATE,
      y = BTUs_res,
      fill = CLASS
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    y = "kBTUs",
    title = "Bay Area Residential Energy Usage"
  )


pge_residential %>% ggplotly()



```



